<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR.js - Car Moving Between Markers</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/jeromeetienne/ar.js/aframe/build/aframe-ar.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; }
    </style>
</head>
<body>
    <a-scene embedded arjs>
        <!-- Marker 1 (start) -->
        <a-marker preset="hiro" id="marker1">
            <a-entity id="car-container">
                <!-- Niebieska rurka w marker1 -->
                <a-cylinder height="2" radius="0.1" color="blue" position="0 1 0"></a-cylinder>
                <!-- Samochód w marker1 -->
                <a-entity id="movingCar" gltf-model="car2.glb" scale="0.2 0.2 0.2"></a-entity>
            </a-entity>
        </a-marker>

        <!-- Marker 2 (middle) -->
        <a-marker preset="kanji" id="marker2">
            <a-cylinder height="2" radius="0.1" color="red" position="0 1 0"></a-cylinder>
        </a-marker>

        <!-- Marker 3 (custom) -->
        <a-marker preset="custom" type="pattern" url="custom-marker.patt" id="marker3">
            <a-cylinder height="2" radius="0.1" color="green" position="0 1 0"></a-cylinder>
        </a-marker>

        <a-entity camera></a-entity>

        <script>
            const marker1 = document.querySelector('#marker1');
            const marker2 = document.querySelector('#marker2');
            const marker3 = document.querySelector('#marker3');
            const car = document.querySelector('#movingCar');
            const carContainer = document.querySelector('#car-container');

            let isMarker1Visible = false;
            let isMarker2Visible = false;
            let isMarker3Visible = false;

            let progress = 0;   // 0 - przy marker1, 1 - przy marker2, 2 - przy marker3
            let direction = 1;  // 1 - do przodu, -1 - wstecz

            let animationFrame;

            marker1.addEventListener('markerFound', () => isMarker1Visible = true);
            marker1.addEventListener('markerLost', () => isMarker1Visible = false);
            marker2.addEventListener('markerFound', () => isMarker2Visible = true);
            marker2.addEventListener('markerLost', () => isMarker2Visible = false);
            marker3.addEventListener('markerFound', () => isMarker3Visible = true);
            marker3.addEventListener('markerLost', () => isMarker3Visible = false);

            function moveCar() {
                if (isMarker1Visible && isMarker2Visible && isMarker3Visible) {
                    // Ustawiamy auto jako widoczne
                    car.setAttribute('visible', 'true');

                    // Pobieramy pozycje markerów w układzie 
                    const worldPos1 = new THREE.Vector3();
                    const worldPos2 = new THREE.Vector3();
                    const worldPos3 = new THREE.Vector3();
                    
                    marker1.object3D.getWorldPosition(worldPos1);
                    marker2.object3D.getWorldPosition(worldPos2);
                    marker3.object3D.getWorldPosition(worldPos3);

                    // Obliczamy lokalną pozycję docelowego markera względem obecnego
                    const currentMarkerIndex = progress % 3;
                    const nextMarkerIndex = (progress + direction + 3) % 3;

                    const currentMarker = marker1.object3D.worldToLocal(positions[nextMarkerIndex].clone());

                    // Aktualizujemy postęp ruchu
                    progress += 0.01 * direction;
                    if (progress >= 3) {
                        progress = 2;
                        direction = -1;
                    } else if (progress < 0) {
                        progress = 0;
                        direction = 1;
                    }

                    // Obliczamy aktualną pozycję samochodu na linii od (0,0,0) w marker1 do localPos2
                    const x = 0 + (currentMarker.x - 0) * (progress % 1);
                    const y = 0 + (currentMarker.y - 0) * (progress % 1);
                    const z = 0 + (currentMarker.z - 0) * (progress % 1);

                    car.object3D.position.set(x, y, z);

                    // Obliczamy kąt
                    let angle = Math.atan2(currentMarker.z, currentMarker.x);
                    if (direction === -1) {
                        angle += Math.PI;
                    }

                    car.object3D.rotation.set(0, -angle, 0);

                } else {
                    // Jeśli oba markery nie są widoczne, ukrywamy samochód.
                    car.setAttribute('visible', 'false');
                }

                animationFrame = requestAnimationFrame(moveCar);
            }

            moveCar();
            window.addEventListener('unload', () => cancelAnimationFrame(animationFrame));
        </script>
    </a-scene>
</body>
</html>

